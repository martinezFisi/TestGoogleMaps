<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Maps</title>
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.11.1/css/alertify.css">

	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/AlertifyJS/1.11.1/alertify.js"></script>

	<style>
		#map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body, .container {
        height: 100%;
        margin: 0 !important;
        padding: 0 !important;
      }

	  .navbar{
	  	margin-bottom: 0px !important;
	  }

	  nav li{
	  	color: white;
	  }

	</style>

</head>
<body>
	

	<nav class="navbar navbar-inverse">
	  <div class="container-fluid">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button>
	      <a class="navbar-brand" href="#">Registro de Denuncias Ciudadanas</a>
	    </div>

	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-nav">
	        <li class="active"><a href="#">Hacer mi denuncia</a></li>
	        <li><a href="#">Buscar denuncias</a></li>
	      </ul>

	      <!-- <form class="navbar-form navbar-right">
	        <div class="form-group">
	          <input type="text" class="form-control" placeholder="Search">
	        </div>
	        <button type="submit" class="btn btn-default">Submit</button>
	      </form> -->

	      <ul class="nav navbar-nav navbar-right">
	        <li class="dropdown">
	          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Mi Perfil<span class="caret"></span></a>
	          <ul class="dropdown-menu">
	            <li><a href="#">Action</a></li>
	            <li role="separator" class="divider"></li>
	            <li><a href="#">Separated link</a></li>
	          </ul>
	        </li>
	      </ul>
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>

	<div class="jumbotron">
	  
	</div>

	<div class="container col-sm-4">
			<div class="panel panel-primary" style="margin-left: 5%; margin-right: 5%">
				<div class="panel-heading">
					Registrar denuncia
				</div>
				<div class="panel-body">
					<form>
						<div class="input-group">
						   <input id="address" type="text" class="form-control" placeholder="Ubicacion">
						   <span class="input-group-btn">
						        <button onclick="buscarUbicacion()" class="btn btn-default" type="button"><span class="glyphicon glyphicon-search"></span></button>
						   </span>
						</div></br>
						<div class="for-group">
							<label>Categoria</label>
							<select id="categoria" class="form-control">
								<option value="RMA">Robo a mano armada</option>
								<option value="RAV">Robo a vehiculo</option>
								<option value="VAN">Vandalismo</option>
								<option value="RAP">Robo al paso</option>
							</select>
						</div></br>
						<div class="for-group">
							<label>Comentario</label>
							<textarea id="Comentario" class="form-control" cols="20" rows="5"></textarea>
						</div>

						</br>
						<button class="btn btn-primary" type="button" onclick="registrarDenuncia()" >Registrar denuncia</button>
					</form>	
				</div>
			</div>	
	</div>

	<div class="col-sm-8" id="map">Mapa</div>
	


	<script>

		var API_GEOCODE_URL = "https://maps.googleapis.com/maps/api/geocode/json";
		var APP_KEY = "AIzaSyCSeQsRYgffothWx8Cfq-7CgcmP4ehKUvY";
		var map;
		var marker;
		var latitud;
		var longitud;

		var facultades = [
	        ['FISI', -12.05366494483155, -77.08547939035185, 4],
	        ['EDUCACION', -12.054336450637866, -77.08462108346708, 5],
	        ['PSICOLOGIA', -12.053413129720905, -77.08713163110502, 3],
	        ['ODONTOLOGIA', -12.05366494483155, -77.08593000146635, 2],
	        ['ELECTRONICA', -12.055438136933262, -77.08676685141774, 1]
      	];

      	function setLatLng(lat, lng){
      		latitud = lat;
      		longitud = lng;
      	}

		function callApiGeoLatLng(addr){
			console.log("Entrando a callApiGeoLatLng(), params: address="+addr);

			console.log("Iniciando conexion con API_GEOCODE...");
			$.ajax({
				type: "GET",
		        url: API_GEOCODE_URL,
		        data: {
		            address: addr,
		            key: APP_KEY
		        },
		        dataType: "json",
		        success: function (result) {
		            //var data = '{ "name": "Antony", "age": "24" }';
		            //var json = JSON.parse(data);

		            console.log("Conexion exitosa, obteniendo latitud y longitud");

		            var json = JSON.stringify(result)
		            var obj = JSON.parse(json);

		            var lat = obj.results[0].geometry.location.lat;
		            var lng = obj.results[0].geometry.location.lng;
		            
		            console.log("lat="+lat+", lng="+lng);
		            initMap(lat, lng);
		            setLatLng(lat, lng);
	    		}
    		});

		}

		function callApiGeoAddress(latitud, longitud){
			console.log("Entrando a callApiGeoAddress(), params: [latitud=" + latitud + ", longitud=" + longitud + "]");

			var latlng = latitud + "," + longitud;

			console.log("Iniciando conexion con API_GEOCODE...");
			$.ajax({
				type: "GET",
		        url: API_GEOCODE_URL,
		        data: {
		            latlng: latlng,
		            key: APP_KEY
		        },
		        dataType: "json",
		        success: function (result) {
		            
		            console.log("Conexion exitosa, obteniendo address");

		            var json = JSON.stringify(result)
		            var obj = JSON.parse(json);

		            var address = obj.results[0].formatted_address;
		            
		            console.log("address="+address);

		            $("#address").val(address);
	    		}
    		});

		}

		function buscarUbicacion(){
			console.log("Entrando a buscarUbicacion()...");
			var address = $("#address").val();

			if( !address ){
				alert("Por favor, ingresa una direccion");
			} else{
				console.log(address);
				callApiGeoLatLng(address);
			}

		}

		
      	function initMap(latitud, longitud) {
      			console.log("Entrando a initMap(), params[latitud=" + latitud + ", longitud=" + longitud + "]");
      			console.log("Generando map...");
        		map = new google.maps.Map($("#map")[0], {
	          		center: {lat: latitud, lng: longitud},
	          		zoom: 17
        		});

        	console.log("Generando marker...");
        	marker = new google.maps.Marker({
	          	map: map,
	          	draggable: true,
	          	animation: google.maps.Animation.DROP,
	          	position: {lat: latitud, lng: longitud}
        	});

        	console.log("Registrando eventos en el marker, events[click, dragend]");
        	marker.addListener('click', toggleBounce);
        	marker.addListener('dragend', dragEnd);

        	setMarkers(map);
      	}

      	function toggleBounce() {
	        if (marker.getAnimation() !== null) {
	          marker.setAnimation(null);
	        } else {
	          marker.setAnimation(google.maps.Animation.BOUNCE);
	        }
      	}

      	function dragEnd(){
      		console.log("Entrando a dragend()");
      		var lat = marker.getPosition().lat();
      		var lng = marker.getPosition().lng();
      		console.log("lat=" + lat + ", lng=" + lng);
      		callApiGeoAddress(lat, lng);
      	}


      	function setMarkers(map) {
	        var image = {
	          url: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
	          
	          size: new google.maps.Size(20, 32),
	          origin: new google.maps.Point(0, 0),
	          anchor: new google.maps.Point(0, 32)
	        };
	        
	        var shape = {
	          coords: [1, 1, 1, 20, 18, 20, 18, 1],
	          type: 'poly'
	        };

	        for (var i = 0; i < facultades.length; i++) {
	          var facultad = facultades[i];
	          var marker = new google.maps.Marker({
	            position: {lat: facultad[1], lng: facultad[2]},
	            map: map,
	            icon: image,
	            shape: shape,
	            title: facultad[0],
	            zIndex: facultad[3]
	          });
	        }
      	}


      	function registrarDenuncia(){

      		console.log("Entrando a registrarDenuncia()");

			var denuncia = {
			    direccion: $("#address").val(),
			    latitud: latitud,
			    longitud: longitud,
			    categoria: $("#categoria").val(),
			    comentario: $("#Comentario").val()
			};

			var denunciaJson = JSON.stringify(denuncia);

			console.log("JSON a enviar: ["+ denunciaJson +"]");
			console.log("Iniciando conexión con Web Service Rest[URL=/denuncias/registrarDenuncia] ....");

			$.ajax({
				type: "POST",
		        url: "http://127.0.0.1:8080/denuncias/registrarDenuncia",
		       	contentType: "application/json; charset=utf-8",
		        data: denunciaJson,
		        success: function (result) {
		        	console.log("Se recibió respuesta del Web Service");
		   
		            var json = JSON.stringify(result);

		            console.log("JSON="+json);

		            if(result.codigo == "OK"){
		            	alertify.success(result.mensaje);
		            }else{
		            	alertify.error(result.mensaje);
		            }

		            
	    		}
    		});

      	}

	</script>


	

	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCSeQsRYgffothWx8Cfq-7CgcmP4ehKUvY"
     defer></script>

</body>
</html>